package application;

import java.io.InputStream;

import communication.Connection;
import javafx.application.Platform;
import javafx.concurrent.Service;
import javafx.concurrent.Task;
import javafx.scene.control.Label;
import userinterface.MultimeterUI;

public class Multimeter extends Service {

	Connection connection;
	public Multimeter (Connection connection) {
		this.connection = connection;
	}


	@Override
	protected Task createTask() {
		return new Task() {
			int result;
			@Override
			protected Object call() throws Exception {
				connection.send((int) '9');
				InputStream input = connection.getInputStream();
				int len = -1;
				result = 0;
				byte[] buffer = new byte[64];
				int[] intbuffer = new int[64];
				try {
					while(! isCancelled()) {
					if( (len = input.read(buffer)) > 0 ) {
		            		System.out.println("THREADDDD");
		            		System.out.println(len);
		            		for(int i = 0; i<len; i++){
		            			intbuffer[i] = buffer[i] & 0xFF;
		            			System.out.println("buffer" + i + " : "+ buffer[i]);
		            			System.out.println("intbuffer" + i + " : "+ intbuffer[i]);
		            		}
		            		if(len>1) {
		            			result = (intbuffer[0] << 8) |  intbuffer[1];
		            			 Platform.runLater(new Runnable() {
				                    	@Override
				                    	public void run() {
				                    		try {
				                    			MultimeterUI.updateMeter((5.11/65536)*result);
//				                    			UI.addData((5.11/65536)*result);
				                    		}
				                    		catch (Exception e) {
				                    			e.printStackTrace();
				                    		}
				                    	}
				                    });
		            		}
		                    System.out.println("string" + new String(intbuffer,0,len));
		                    System.out.println("result" + result);
		                    System.out.println("volt" + (5.11/65536)*result);
		                   
		            	}
					}
				} catch (Exception e) {
					e.printStackTrace();
				}
				return null;
			}
		};
	}
}
